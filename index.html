<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>محاسبه‌گر فوق لحظه‌ای تتر</title>
    <style>
        :root { --primary: #0061ff; --secondary: #607d8b; --success: #00c853; }
        body { font-family: Tahoma, sans-serif; background: #f4f7f6; display: flex; justify-content: center; padding: 20px; direction: rtl; }
        .container { background: white; width: 100%; max-width: 500px; padding: 25px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: var(--secondary); font-size: 1.2rem; margin-bottom: 20px; }
        .price-card { background: linear-gradient(135deg, #1a237e, #283593); color: white; padding: 20px; border-radius: 20px; text-align: center; margin-bottom: 20px; position: relative; overflow: hidden; }
        .price-card span { display: block; font-size: 0.9rem; opacity: 0.8; }
        .price-card strong { font-size: 1.8rem; display: block; margin-top: 5px; }
        .btn-update { width: 100%; border: none; background: var(--primary); color: white; padding: 12px; border-radius: 12px; font-family: Tahoma; cursor: pointer; font-weight: bold; margin-bottom: 20px; transition: 0.3s; }
        .btn-update:active { transform: scale(0.98); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: center; padding: 10px; color: #9e9e9e; font-size: 0.8rem; border-bottom: 1px solid #eee; }
        td { text-align: center; padding: 12px; border-bottom: 1px solid #fafafa; font-size: 0.95rem; font-weight: bold; }
        .toman { color: #d32f2f; }
        .usd-plus { color: var(--success); }
    </style>
</head>
<body>

<div class="container">
    <h2>محاسبه نرخ ریالی تتر (+۱۵٪)</h2>
    
    <div class="price-card">
        <span>قیمت لحظه‌ای بازار نوبیتکس:</span>
        <strong id="live-price">در حال دریافت...</strong>
        <small id="time-stamp" style="font-size: 0.7rem; opacity: 0.6;"></small>
    </div>

    <button class="btn-update" onclick="fetchPrice()">بروزرسانی اجباری قیمت</button>

    <table>
        <thead>
            <tr>
                <th>دلار اصلی</th>
                <th>+۱۵٪</th>
                <th>تومان نهایی</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>
</div>

<script>
    const amounts = [100, 300, 500, 700, 800, 900, 1000, 1500, 2000, 2500, 3000];

    async function fetchPrice() {
        const priceEl = document.getElementById('live-price');
        const timeEl = document.getElementById('time-stamp');
        
        priceEl.innerText = "بروزرسانی...";

        try {
            // استفاده از نوبیتکس با پارامتر ضد کش قوی
            // آدرس نوبیتکس مستقیم در مرورگر معمولاً CORS خطای می‌دهد، 
            // بنابراین از یک پراکسی استفاده می‌کنیم که کش نمی‌کند
            const proxy = "https://api.allorigins.win/get?url=";
            const target = encodeURIComponent("https://api.nobitex.ir/v2/orderbook/USDTIRT");
            const finalUrl = `${proxy}${target}&nocache=${new Date().getTime()}`;

            const response = await fetch(finalUrl, { cache: "no-store" });
            const json = await response.json();
            const data = JSON.parse(json.contents);
            
            // قیمت آخرین معامله به ریال است، تبدیل به تومان
            const priceInToman = parseInt(data.lastTradePrice) / 10;

            if (priceInToman > 0) {
                priceEl.innerText = priceInToman.toLocaleString() + " تومان";
                timeEl.innerText = new Date().toLocaleTimeString('fa-IR');
                renderRows(priceInToman);
            }
        } catch (error) {
            priceEl.innerText = "خطا در منبع اصلی";
            console.error(error);
            // تلاش دوم با منبع جایگزین در صورت خطا
            fallbackPrice();
        }
    }

    async function fallbackPrice() {
        // منبع جایگزین مستقیم (Tetherland) با پارامتر تصادفی
        const response = await fetch(`https://api.tetherland.com/currencies?v=${Math.random()}`, { cache: "no-store" });
        const data = await response.json();
        const price = parseInt(data.data.currencies.USDT.price);
        document.getElementById('live-price').innerText = price.toLocaleString() + " تومان";
        renderRows(price);
    }

    function renderRows(price) {
        const tbody = document.getElementById('rows');
        tbody.innerHTML = '';
        amounts.forEach(amt => {
            const plus15 = amt * 1.15;
            const finalToman = Math.round(plus15 * price);
            tbody.innerHTML += `
                <tr>
                    <td style="color:#757575">$${amt.toLocaleString()}</td>
                    <td class="usd-plus">$${plus15.toLocaleString()}</td>
                    <td class="toman">${finalToman.toLocaleString()}</td>
                </tr>`;
        });
    }

    // اجرای خودکار در شروع
    fetchPrice();
</script>

</body>
</html>
